<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priority Task List</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js');
  }
  </script>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .settings-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: background 0.3s;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .settings-btn span {
            width: 24px;
            height: 3px;
            background: white;
            border-radius: 2px;
        }

        .filter-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .filter-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .filter-dropdown {
            position: absolute;
            top: 80px;
            left: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .filter-dropdown.active {
            display: block;
        }

        .filter-option {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            color: #212529;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filter-option:hover {
            background: #f8f9fa;
        }

        .filter-option.selected {
            background: #e7f3ff;
            color: #0066cc;
            font-weight: 600;
        }

        .filter-count {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .filter-option.selected .filter-count {
            background: #cce5ff;
            color: #0066cc;
        }

        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            z-index: 100;
        }

        .add-btn:hover {
            transform: scale(1.1);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #212529;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6c757d;
            line-height: 1;
        }

        .close-btn:hover {
            color: #212529;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input[type="text"],
        .form-group input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .slider-container {
            margin-top: 10px;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 5px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 30px;
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
        }

        .btn-save {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-save:hover {
            transform: translateY(-2px);
        }

        .task-list {
            padding: 20px 30px 30px 30px;
        }

        .task-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .task-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .task-item.completed {
            opacity: 0.6;
            background: #f8f9fa;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6c757d;
            flex-wrap: wrap;
        }

        .task-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .task-tag {
            background: #e7f3ff;
            color: #0066cc;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .score-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .task-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .weights-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #6c757d;
        }

        .weights-info strong {
            color: #495057;
        }

        .weight-note {
            margin-top: 15px;
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }

        .subtasks-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .subtasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subtasks-header h3 {
            color: #495057;
            font-size: 16px;
        }

        .btn-add-subtask {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-add-subtask:hover {
            background: #218838;
        }

        .subtask-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .subtask-item input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-remove-subtask {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-remove-subtask:hover {
            background: #c82333;
        }

        .subtask-empty {
            color: #6c757d;
            font-size: 14px;
            font-style: italic;
        }

        .task-item.expanded {
            background: #f8f9fa;
        }

        .task-subtasks {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
        }

        .task-subtasks-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }

        .task-subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .task-subtask-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-subtask-text {
            flex: 1;
            color: #212529;
            font-size: 14px;
        }

        .task-subtask-item.completed .task-subtask-text {
            text-decoration: line-through;
            color: #6c757d;
        }

        .subtask-progress {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .task-item.expanded .expand-btn {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="filter-btn" onclick="toggleFilterDropdown()">
                üè∑Ô∏è Filter
            </button>
            <div class="filter-dropdown" id="filterDropdown"></div>
            <button class="settings-btn" onclick="openSettingsModal()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1>üìã Priority Task List</h1>
            <p>Organize tasks by urgency, importance, and effort</p>
        </div>

        <div class="task-list" id="taskList">
            <div class="empty-state">
                <h3>No tasks yet</h3>
                <p>Click the + button to add your first task!</p>
            </div>
        </div>
    </div>

    <button class="add-btn" onclick="openModal()">+</button>

    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Add New Task</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="form-group">
                <label for="taskName">Task Name</label>
                <input type="text" id="taskName" placeholder="Enter your task...">
            </div>

            <div class="form-group">
                <label for="taskTag">Tag (optional)</label>
                <input type="text" id="taskTag" placeholder="e.g., Work, Personal, Study...">
            </div>

            <div class="form-group">
                <label for="importance">Importance</label>
                <div class="slider-wrapper">
                    <input type="range" id="importance" class="slider" min="0" max="5" value="0" oninput="updateSliderValue('importance')">
                    <span class="slider-value" id="importanceValue">0</span>
                </div>
            </div>

            <div class="form-group">
                <label for="effort">Effort</label>
                <div class="slider-wrapper">
                    <input type="range" id="effort" class="slider" min="0" max="5" value="0" oninput="updateSliderValue('effort')">
                    <span class="slider-value" id="effortValue">0</span>
                </div>
            </div>

            <div class="form-group">
                <label for="deadline">Deadline</label>
                <input type="date" id="deadline">
            </div>

            <div class="subtasks-section">
                <div class="subtasks-header">
                    <h3>Subtasks (optional)</h3>
                    <button type="button" class="btn-add-subtask" onclick="addSubtaskInput()">+ Add Subtask</button>
                </div>
                <div id="subtasksList">
                    <p class="subtask-empty">No subtasks added yet</p>
                </div>
            </div>

            <button class="btn-save" onclick="addTask()">Save Task</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModalOverlay" onclick="closeSettingsModalOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>‚öôÔ∏è Weight Settings</h2>
                <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
            </div>

            <div class="weights-info">
                <strong>Current Formula:</strong> Score = (Importance √ó <span id="displayImportanceWeight">0.1</span>) + (Effort √ó <span id="displayEffortWeight">0.4</span>) + ((Days remaining √∑ 2) √ó <span id="displayUrgencyWeight">0.5</span>)
            </div>

            <div class="form-group">
                <label for="importanceWeight">Importance Weight</label>
                <div class="slider-wrapper">
                    <input type="range" id="importanceWeight" class="slider" min="0" max="1" step="0.1" value="0.1" oninput="updateWeightSlider('importanceWeight')">
                    <span class="slider-value" id="importanceWeightValue">0.1</span>
                </div>
            </div>

            <div class="form-group">
                <label for="effortWeight">Effort Weight</label>
                <div class="slider-wrapper">
                    <input type="range" id="effortWeight" class="slider" min="0" max="1" step="0.1" value="0.4" oninput="updateWeightSlider('effortWeight')">
                    <span class="slider-value" id="effortWeightValue">0.4</span>
                </div>
            </div>

            <div class="form-group">
                <label for="urgencyWeight">Urgency Weight (Days Remaining)</label>
                <div class="slider-wrapper">
                    <input type="range" id="urgencyWeight" class="slider" min="0" max="1" step="0.1" value="0.5" oninput="updateWeightSlider('urgencyWeight')">
                    <span class="slider-value" id="urgencyWeightValue">0.5</span>
                </div>
            </div>

            <div class="weight-note">
                üí° Adjust these weights to change how tasks are prioritized. Higher weights mean that category has more influence on the score.
            </div>

            <button class="btn-save" onclick="saveWeights()">Apply Weights</button>
        </div>
    </div>

    <script>
        let tasks = [];
        let weights = {
            importance: 0.1,
            effort: 0.4,
            urgency: 0.5
        };
        let currentFilter = 'all';
        let subtaskInputs = [];
        let expandedTasks = new Set();
        let editingTaskId = null;

        // Load data from localStorage on startup
        function loadData() {
            const savedTasks = localStorage.getItem('tasks');
            const savedWeights = localStorage.getItem('weights');
            const savedFilter = localStorage.getItem('currentFilter');
            
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
            if (savedWeights) {
                weights = JSON.parse(savedWeights);
                // Update settings modal with saved weights
                document.getElementById('importanceWeight').value = weights.importance;
                document.getElementById('effortWeight').value = weights.effort;
                document.getElementById('urgencyWeight').value = weights.urgency;
                document.getElementById('importanceWeightValue').textContent = weights.importance.toFixed(1);
                document.getElementById('effortWeightValue').textContent = weights.effort.toFixed(1);
                document.getElementById('urgencyWeightValue').textContent = weights.urgency.toFixed(1);
                document.getElementById('displayImportanceWeight').textContent = weights.importance.toFixed(1);
                document.getElementById('displayEffortWeight').textContent = weights.effort.toFixed(1);
                document.getElementById('displayUrgencyWeight').textContent = weights.urgency.toFixed(1);
            }
            if (savedFilter) {
                currentFilter = savedFilter;
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('weights', JSON.stringify(weights));
            localStorage.setItem('currentFilter', currentFilter);
        }

        // Set minimum date to today
        document.getElementById('deadline').min = new Date().toISOString().split('T')[0];

        function openModal() {
            editingTaskId = null;
            document.getElementById('modalOverlay').classList.add('active');
            document.querySelector('.modal h2').textContent = 'Add New Task';
            document.querySelector('.btn-save').textContent = 'Save Task';
            // Reset sliders to 0
            document.getElementById('importance').value = '0';
            document.getElementById('effort').value = '0';
            document.getElementById('importanceValue').textContent = '0';
            document.getElementById('effortValue').textContent = '0';
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            editingTaskId = null;
            // Clear form
            document.getElementById('taskName').value = '';
            document.getElementById('taskTag').value = '';
            document.getElementById('importance').value = '0';
            document.getElementById('effort').value = '0';
            document.getElementById('importanceValue').textContent = '0';
            document.getElementById('effortValue').textContent = '0';
            document.getElementById('deadline').value = '';
            // Clear subtasks
            subtaskInputs = [];
            document.getElementById('subtasksList').innerHTML = '<p class="subtask-empty">No subtasks added yet</p>';
            // Reset modal title
            document.querySelector('.modal h2').textContent = 'Add New Task';
            document.querySelector('.btn-save').textContent = 'Save Task';
        }

        function closeModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        function updateSliderValue(sliderId) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(sliderId + 'Value');
            valueDisplay.textContent = slider.value;
        }

        function addSubtaskInput() {
            // Save current values before adding new input
            const currentValues = subtaskInputs.map(item => {
                const itemId = typeof item === 'object' ? item.tempId : item;
                const input = document.getElementById(`subtask-${itemId}`);
                const text = input ? input.value : (typeof item === 'object' ? item.text : '');
                
                if (typeof item === 'object') {
                    return { ...item, text };
                } else {
                    return { tempId: item, text, id: null, completed: false };
                }
            });
            
            // Add new subtask
            const id = Date.now();
            currentValues.push({ tempId: id, text: '', id: null, completed: false });
            
            subtaskInputs = currentValues;
            renderSubtaskInputs();
        }

        function removeSubtaskInput(id) {
            subtaskInputs = subtaskInputs.filter(item => {
                const itemId = typeof item === 'object' ? item.tempId : item;
                return itemId !== id;
            });
            renderSubtaskInputs();
        }

        function renderSubtaskInputs() {
            const container = document.getElementById('subtasksList');
            
            if (subtaskInputs.length === 0) {
                container.innerHTML = '<p class="subtask-empty">No subtasks added yet</p>';
                return;
            }

            container.innerHTML = subtaskInputs.map(item => {
                const text = typeof item === 'object' ? item.text : '';
                const id = typeof item === 'object' ? item.tempId : item;
                return `
                    <div class="subtask-item">
                        <input type="text" id="subtask-${id}" placeholder="Enter subtask..." value="${text}">
                        <button type="button" class="btn-remove-subtask" onclick="removeSubtaskInput(${id})">Remove</button>
                    </div>
                `;
            }).join('');
        }

        function openSettingsModal() {
            document.getElementById('settingsModalOverlay').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModalOverlay').classList.remove('active');
        }

        function closeSettingsModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeSettingsModal();
            }
        }

        function updateWeightSlider(sliderId) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(sliderId + 'Value');
            valueDisplay.textContent = parseFloat(slider.value).toFixed(1);
            
            // Update display in formula
            if (sliderId === 'importanceWeight') {
                document.getElementById('displayImportanceWeight').textContent = parseFloat(slider.value).toFixed(1);
            } else if (sliderId === 'effortWeight') {
                document.getElementById('displayEffortWeight').textContent = parseFloat(slider.value).toFixed(1);
            } else if (sliderId === 'urgencyWeight') {
                document.getElementById('displayUrgencyWeight').textContent = parseFloat(slider.value).toFixed(1);
            }
        }

        function saveWeights() {
            weights.importance = parseFloat(document.getElementById('importanceWeight').value);
            weights.effort = parseFloat(document.getElementById('effortWeight').value);
            weights.urgency = parseFloat(document.getElementById('urgencyWeight').value);
            
            saveData(); // Save to localStorage
            closeSettingsModal();
            renderTasks(); // Re-render tasks with new weights
        }

        function toggleFilterDropdown() {
            const dropdown = document.getElementById('filterDropdown');
            dropdown.classList.toggle('active');
            if (dropdown.classList.contains('active')) {
                updateFilterDropdown();
            }
        }

        function updateFilterDropdown() {
            const dropdown = document.getElementById('filterDropdown');
            
            // Get all unique tags
            const tags = [...new Set(tasks.map(t => t.tag).filter(tag => tag))];
            
            // Count tasks for each tag
            const tagCounts = {};
            tagCounts['all'] = tasks.length;
            tags.forEach(tag => {
                tagCounts[tag] = tasks.filter(t => t.tag === tag).length;
            });
            
            // Build dropdown HTML
            let html = `
                <div class="filter-option ${currentFilter === 'all' ? 'selected' : ''}" onclick="applyFilter('all')">
                    <span>All Tasks</span>
                    <span class="filter-count">${tagCounts['all']}</span>
                </div>
            `;
            
            tags.forEach(tag => {
                html += `
                    <div class="filter-option ${currentFilter === tag ? 'selected' : ''}" onclick="applyFilter('${tag}')">
                        <span>${tag}</span>
                        <span class="filter-count">${tagCounts[tag]}</span>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
        }

        function applyFilter(filter) {
            currentFilter = filter;
            saveData(); // Save filter preference
            document.getElementById('filterDropdown').classList.remove('active');
            renderTasks();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('filterDropdown');
            const filterBtn = document.querySelector('.filter-btn');
            
            if (!dropdown.contains(event.target) && !filterBtn.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        function addTask() {
            const name = document.getElementById('taskName').value.trim();
            const tag = document.getElementById('taskTag').value.trim();
            const importance = parseInt(document.getElementById('importance').value);
            const effort = parseInt(document.getElementById('effort').value);
            const deadline = document.getElementById('deadline').value;

            if (!name) {
                alert('Please enter a task name');
                return;
            }

            if (!deadline) {
                alert('Please select a deadline');
                return;
            }

            // Collect subtasks
            const subtasks = subtaskInputs
                .map(item => {
                    const id = typeof item === 'object' ? item.tempId : item;
                    const input = document.getElementById(`subtask-${id}`);
                    const text = input ? input.value.trim() : '';
                    const originalId = typeof item === 'object' ? item.id : null;
                    const completed = typeof item === 'object' ? item.completed : false;
                    
                    return { text, originalId, completed };
                })
                .filter(st => st.text !== '')
                .map(st => ({
                    id: st.originalId || (Date.now() + Math.random()),
                    text: st.text,
                    completed: st.completed
                }));

            if (editingTaskId) {
                // Update existing task
                const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = {
                        ...tasks[taskIndex],
                        name: name,
                        tag: tag,
                        importance: importance,
                        effort: effort,
                        deadline: deadline,
                        subtasks: subtasks
                    };
                }
            } else {
                // Create new task
                const task = {
                    id: Date.now(),
                    name: name,
                    tag: tag,
                    importance: importance,
                    effort: effort,
                    deadline: deadline,
                    completed: false,
                    subtasks: subtasks
                };
                tasks.push(task);
            }

            closeModal();
            saveData(); // Save to localStorage
            renderTasks();
        }

        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            editingTaskId = id;

            // Populate form
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskTag').value = task.tag || '';
            document.getElementById('importance').value = task.importance;
            document.getElementById('effort').value = task.effort;
            document.getElementById('importanceValue').textContent = task.importance;
            document.getElementById('effortValue').textContent = task.effort;
            document.getElementById('deadline').value = task.deadline;

            // Populate subtasks
            subtaskInputs = task.subtasks.map(st => ({
                tempId: Date.now() + Math.random(),
                id: st.id,
                text: st.text,
                completed: st.completed
            }));
            renderSubtaskInputs();

            // Update modal title
            document.querySelector('.modal h2').textContent = 'Edit Task';
            document.querySelector('.btn-save').textContent = 'Update Task';

            // Open modal
            document.getElementById('modalOverlay').classList.add('active');
        }

        function calculateScore(task) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(task.deadline);
            deadlineDate.setHours(0, 0, 0, 0);
            
            const daysRemaining = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
            
            // Formula using custom weights
            const score = (task.importance * weights.importance) + 
                         (task.effort * weights.effort) + 
                         ((daysRemaining / 2) * weights.urgency);
            
            return {
                score: score,
                daysRemaining: daysRemaining
            };
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                saveData(); // Save to localStorage
                renderTasks();
            }
        }

        function toggleTaskExpansion(id) {
            if (expandedTasks.has(id)) {
                expandedTasks.delete(id);
            } else {
                expandedTasks.add(id);
            }
            renderTasks();
        }

        function toggleSubtask(taskId, subtaskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const subtask = task.subtasks.find(st => st.id === subtaskId);
                if (subtask) {
                    subtask.completed = !subtask.completed;
                    saveData(); // Save to localStorage
                    renderTasks();
                }
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveData(); // Save to localStorage
            renderTasks();
        }

        function renderTasks() {
            const taskList = document.getElementById('taskList');
            
            // Filter tasks based on current filter
            let filteredTasks = tasks;
            if (currentFilter !== 'all') {
                filteredTasks = tasks.filter(t => t.tag === currentFilter);
            }
            
            if (filteredTasks.length === 0) {
                const message = currentFilter === 'all' 
                    ? 'Click the + button to add your first task!'
                    : `No tasks with tag "${currentFilter}"`;
                taskList.innerHTML = `
                    <div class="empty-state">
                        <h3>No tasks ${currentFilter === 'all' ? 'yet' : 'found'}</h3>
                        <p>${message}</p>
                    </div>
                `;
                return;
            }

            // Calculate scores for filtered tasks
            const tasksWithScores = filteredTasks.map(task => ({
                ...task,
                ...calculateScore(task)
            }));

            // Sort: incomplete tasks by score (descending), then completed tasks
            const sortedTasks = tasksWithScores.sort((a, b) => {
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                if (!a.completed && !b.completed) {
                    return b.score - a.score;
                }
                return 0;
            });

            taskList.innerHTML = sortedTasks.map(task => {
                const isExpanded = expandedTasks.has(task.id);
                const hasSubtasks = task.subtasks && task.subtasks.length > 0;
                const completedSubtasks = hasSubtasks ? task.subtasks.filter(st => st.completed).length : 0;
                const totalSubtasks = hasSubtasks ? task.subtasks.length : 0;
                const progressPercentage = totalSubtasks > 0 ? (completedSubtasks / totalSubtasks) * 100 : 0;
                
                let subtasksHtml = '';
                if (hasSubtasks && isExpanded) {
                    subtasksHtml = `
                        <div class="task-subtasks">
                            <div class="subtask-progress">üìã Subtasks: ${completedSubtasks}/${totalSubtasks} completed</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                            ${task.subtasks.map(subtask => `
                                <div class="task-subtask-item ${subtask.completed ? 'completed' : ''}">
                                    <input 
                                        type="checkbox" 
                                        ${subtask.completed ? 'checked' : ''}
                                        onchange="toggleSubtask(${task.id}, ${subtask.id})"
                                    >
                                    <span class="task-subtask-text">${subtask.text}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Progress bar visible even when collapsed
                let collapsedProgressBar = '';
                if (hasSubtasks && !isExpanded) {
                    collapsedProgressBar = `
                        <div class="progress-bar-container" style="margin-top: 10px;">
                            <div class="progress-bar-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    `;
                }
                
                return `
                <div class="task-item ${task.completed ? 'completed' : ''} ${isExpanded ? 'expanded' : ''}">
                    ${hasSubtasks ? `<button class="expand-btn" onclick="toggleTaskExpansion(${task.id})">‚ñ∂</button>` : '<div style="width: 24px;"></div>'}
                    <input 
                        type="checkbox" 
                        class="task-checkbox" 
                        ${task.completed ? 'checked' : ''}
                        onchange="toggleTask(${task.id})"
                    >
                    <div class="task-content">
                        <div class="task-title">${task.name}</div>
                        <div class="task-meta">
                            <span>‚è∞ ${task.daysRemaining} days left</span>
                            <span>‚≠ê Importance: ${task.importance}</span>
                            <span>üí™ Effort: ${task.effort}</span>
                            ${task.tag ? `<span class="task-tag">${task.tag}</span>` : ''}
                            ${hasSubtasks && !isExpanded ? `<span>üìã ${completedSubtasks}/${totalSubtasks} subtasks</span>` : ''}
                        </div>
                        ${collapsedProgressBar}
                        ${subtasksHtml}
                    </div>
                    <div class="score-badge">Score: ${task.score.toFixed(2)}</div>
                    <div class="task-actions">
                        <button class="btn-edit" onclick="editTask(${task.id})">Edit</button>
                        <button class="btn-delete" onclick="deleteTask(${task.id})">Delete</button>
                    </div>
                </div>
            `}).join('');
        }

        // Initial render
        loadData();
        renderTasks();
    </script>
</body>
</html>